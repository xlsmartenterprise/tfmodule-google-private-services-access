# tfmodule-google-private-services-access

Terraform module for configuring Private Service Access in Google Cloud Platform. This module creates the necessary networking resources to enable private connectivity between your VPC network and Google-managed services such as Cloud SQL, Cloud Memorystore, and other services that support Private Service Access.

## Features

- **Global IP Address Reservation**: Allocates a global IP address range for VPC peering with Google-managed services
- **Service Networking Connection**: Establishes private connectivity to servicenetworking.googleapis.com
- **Flexible IP Configuration**: Supports custom IP address ranges, prefix lengths, and both IPv4 and IPv6
- **Safe Resource Deletion**: Configurable deletion policy with ABANDON option to prevent dangling resources
- **Dependency Management**: Built-in dependency tracking for ordered resource creation
- **Automatic Network Discovery**: Uses data source to reference existing VPC networks

## Usage

### Basic Example

```hcl
module "private_service_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id    = "my-project-id"
  vpc_network   = "my-vpc-network"
  name          = "google-managed-services-range"
  prefix_length = 16
}
```

### Custom IP Range Example

```hcl
module "private_service_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id    = "my-project-id"
  vpc_network   = "my-vpc-network"
  name          = "cloudsql-private-range"
  address       = "10.100.0.0"
  prefix_length = 20
  ip_version    = "IPV4"
}
```

### With Deletion Policy for Safe Cleanup

```hcl
module "private_service_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id      = "my-project-id"
  vpc_network     = "my-vpc-network"
  name            = "google-services-range"
  prefix_length   = 16
  deletion_policy = "ABANDON"
}
```

### Shared VPC Example

```hcl
module "private_service_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id    = "shared-vpc-host-project"
  vpc_network   = "shared-vpc-network"
  name          = "shared-vpc-private-services"
  prefix_length = 16
}
```

### Multiple Service Ranges Example

```hcl
# Range for Cloud SQL
module "cloudsql_private_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id    = "my-project-id"
  vpc_network   = "my-vpc-network"
  name          = "cloudsql-range"
  address       = "10.50.0.0"
  prefix_length = 20
}

# Range for Memorystore
module "memorystore_private_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id    = "my-project-id"
  vpc_network   = "my-vpc-network"
  name          = "memorystore-range"
  address       = "10.60.0.0"
  prefix_length = 24
}
```

### With Dependency Management Example

```hcl
module "private_service_access" {
  source = "github.com/xlsmartenterprise/tfmodule-google-private-services-access"

  project_id    = "my-project-id"
  vpc_network   = "my-vpc-network"
  name          = "google-services-range"
  prefix_length = 16
}

# Cloud SQL instance that depends on Private Service Access
resource "google_sql_database_instance" "main" {
  name             = "my-database"
  database_version = "POSTGRES_15"
  region           = "us-central1"

  settings {
    tier = "db-f1-micro"
    ip_configuration {
      ipv4_enabled    = false
      private_network = "projects/${var.project_id}/global/networks/${var.vpc_network}"
    }
  }

  depends_on = [module.private_service_access]
}
```

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|----------|
| name | Name of the global address resource | `string` | n/a | yes |
| project_id | The project ID of the VPC network to peer. This can be a shared VPC host project | `string` | n/a | yes |
| vpc_network | Name of the VPC network to peer | `string` | n/a | yes |
| prefix_length | Prefix length of the IP range reserved for Cloud SQL instances and other Private Service Access services | `number` | n/a | yes |
| address | First IP address of the IP range to allocate to Cloud SQL instances and other Private Service Access services. If not set, GCP will pick a valid one for you | `string` | `""` | no |
| ip_version | IP Version for the allocation. Can be IPV4 or IPV6 | `string` | `""` | no |
| deletion_policy | The deletion policy for the service networking connection. Setting to ABANDON allows the resource to be abandoned rather than deleted. This will enable a successful terraform destroy when destroying CloudSQL instances. Use with care as it can lead to dangling resources | `string` | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| address | First IP of the reserved range |
| google_compute_global_address_name | Name of the reserved range |
| peering_completed | Use for enforce ordering between resource creation |

## Requirements

| Name | Version |
|------|---------|
| terraform | >= 1.5.0 |
| google | >= 7.0.0, < 8.0.0 |
| google-beta | >= 7.0.0, < 8.0.0 |

## Notes

### IP Range Planning

- Ensure the IP range does not overlap with existing subnets in your VPC
- Recommended prefix length is /16 for flexibility
- Plan ahead for multiple services that may need separate ranges

### Deletion Policy

- Use `deletion_policy = "ABANDON"` when you need to destroy resources without deleting the underlying peering
- This is particularly useful when managing Cloud SQL instances that depend on this connection
- Without ABANDON policy, Terraform may fail to destroy resources if services are still using the peering

### Shared VPC

- For Shared VPC setups, specify the host project ID in `project_id`
- The service project will automatically inherit the private service access configuration

### Service Networking API

- Ensure the Service Networking API (`servicenetworking.googleapis.com`) is enabled in your project
- The module creates a peering connection to this service automatically

## Troubleshooting

### Error: IP range overlaps with existing subnet

**Solution**: Choose a different IP range that doesn't conflict with your existing VPC subnets.

### Error: Service Networking API not enabled

**Solution**: Enable the API with:
```bash
gcloud services enable servicenetworking.googleapis.com --project=PROJECT_ID
```

### Error: Cannot delete peering connection

**Solution**: Set `deletion_policy = "ABANDON"` to allow Terraform to abandon the resource during destruction.

## Changelog

See [CHANGELOG.md](./CHANGELOG.md) for version history and changes.